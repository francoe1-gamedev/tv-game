<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Receiver</title>
  <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
  <script src="https://cdn.ably.io/lib/ably.min-1.js"></script>

  <style>
    body {
      background: #111;
      color: white;
      font-family: sans-serif;
      text-align: center;
      padding-top: 2em;
    }

    #qr {
      margin-top: 1em;
    }
  </style>
</head>

<body>
  <h1>ðŸ“º TV Receiver</h1>
  <div>
    <h2 id="code"></h2>
    <canvas id="qr" style="flex-grow: 0;" width="200" height="200"></canvas>
    <br>
    <iframe src="/dice.html" width="450" height="450" style="overflow: hidden; outline: none; border: none;"></iframe>
  </div>


  <ul id="log"></ul>

  <script>
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    const code = Array.from({ length: 6 }, () => chars[Math.floor(Math.random() * chars.length)]).join('');

    const joinUrl = `${window.location.origin}/controller.html?code=${code}`;
    document.getElementById('code').textContent = `CÃ³digo: ${code}`;

    // Generar el QR
    const qr = new QRious({
      element: document.getElementById('qr'),
      value: joinUrl,
      size: 200,
      background: '#fff',
      foreground: '#000'
    });

    const ably = new Ably.Realtime('2FeVXA.l-xcog:LMmVSofRgR-9fjIRoAGRxmcj5IeC5uY0BRKfiE1A0NE');
    const channel = ably.channels.get(`game-${code}`);
    const userChannels = [];

    channel.subscribe('join', (msg) => {
      const channelName = `player-${msg.connectionId}`;
      userChannels[msg.connectionId] = ably.channels.get(channelName);

      userChannels[msg.connectionId].subscribe('input', (msg) => {
        const { action } = msg.data;
        console.log(`[${msg.connectionId}] ${action}`);
      });

      channel.publish('player-join', { channelName });
      console.log(`Connected player ${msg.connectionId}`);
    })

    function startGame() {
      channel.publish('start', {});
    }

  </script>
</body>

</html>